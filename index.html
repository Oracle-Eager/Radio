<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Macro</title>
    
    <link rel="preconnect" href="https://picsum.photos">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@600&family=Inter:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- BASE & FONT STYLES --- */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }
        .font-serif-artistic {
            font-family: 'Lora', serif;
        }

        /* --- MACRO UI & LIQUID GLASS DESIGN --- */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.4); 
            --glass-border: rgba(255, 255, 255, 0.25);
            --glass-blur: 30px;
            --soft-shadow: 0 10px 35px rgba(45, 55, 72, 0.1);
        }

        body {
            background-color: #f0f9ff;
            background-image: radial-gradient(at 20% 20%, hsla(217, 100%, 97%, 1) 0px, transparent 50%),
                              radial-gradient(at 80% 30%, hsla(28, 100%, 97%, 1) 0px, transparent 50%),
                              radial-gradient(at 10% 90%, hsla(343, 100%, 98%, 1) 0px, transparent 50%),
                              radial-gradient(at 90% 80%, hsla(240, 100%, 98%, 1) 0px, transparent 50%);
        }

        .glass-ui {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            box-shadow: var(--soft-shadow);
        }

        /* --- ADVANCED SPLASH SCREEN & LOGO ANIMATION --- */
        #splash-screen {
            transition: opacity 0.5s ease-out 2.8s;
        }
        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .macro-logo {
            position: relative;
            width: 150px;
            height: 150px;
        }
        .logo-core {
            position: absolute;
            top: 50%;
            left: 50%;
            font-family: 'Lora', serif;
            font-size: 4rem;
            font-weight: 600;
            color: #334155;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) 1.5s forwards;
        }
        .logo-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid;
            border-color: transparent;
            opacity: 0;
            transform: scale(0.5) rotate(-180deg);
        }
        .logo-ring-1 {
            border-top-color: #38bdf8;
            animation: drawIn 1.2s ease-out 0.2s forwards, spinFade 1.5s ease-in-out 1.4s infinite;
        }
        .logo-ring-2 {
            border-right-color: #fb7185;
            animation: drawIn 1.2s ease-out 0.5s forwards, spinFade 1.5s ease-in-out 1.7s infinite reverse;
        }
        .logo-ring-3 {
            border-left-color: #a78bfa;
            animation: drawIn 1.2s ease-out 0.8s forwards, spinFade 1.5s ease-in-out 2s infinite;
        }

        @keyframes drawIn { to { transform: scale(1) rotate(0deg); opacity: 1; } }
        @keyframes popIn { to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        @keyframes spinFade {
            0%, 100% { opacity: 1; transform: rotate(0deg) scale(1); }
            50% { opacity: 0.5; transform: rotate(180deg) scale(0.95); }
        }

        /* --- IMPROVED IMAGE TRANSITION --- */
        #album-art-container { position: relative; width: 100%; height: 100%; }
        .album-art-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            transition: opacity 1.5s cubic-bezier(0.4, 0, 0.2, 1), transform 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(1.05); opacity: 0;
        }
        .album-art-img.visible { opacity: 1; transform: scale(1); }

        /* --- PERFORMANCE & UI STABILITY --- */
        #panel-content {
            transition: transform 0.6s cubic-bezier(0.32, 0.72, 0, 1);
            will-change: transform;
        }
        .interactive-btn { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .interactive-btn:active { transform: scale(0.95); }
        #play-pause-btn { background-image: linear-gradient(to top, #f3f4f6, #ffffff); }

        /* --- LIVE PLAYING INDICATOR --- */
        .playing-indicator {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 16px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .station-item.is-playing .playing-indicator {
            opacity: 1;
        }
        .playing-indicator span {
            width: 3px;
            height: 100%;
            background-color: #3b82f6;
            border-radius: 2px;
            animation: soundwave 1.2s ease-in-out infinite alternate;
        }
        .playing-indicator span:nth-child(2) { animation-delay: -0.8s; }
        .playing-indicator span:nth-child(3) { animation-delay: -0.4s; }

        @keyframes soundwave {
            from { transform: scaleY(0.2); }
            to { transform: scaleY(1); }
        }
    </style>
</head>
<body class="overflow-hidden">

    <div id="splash-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-100">
        <div class="macro-logo">
            <div class="logo-ring logo-ring-1"></div>
            <div class="logo-ring logo-ring-2"></div>
            <div class="logo-ring logo-ring-3"></div>
            <div class="logo-core">M</div>
        </div>
    </div>

    <div id="macro-player" class="relative w-full h-screen flex flex-col text-gray-700 opacity-0 transition-opacity duration-1000">
        
        <header class="flex items-center justify-end p-6 flex-shrink-0 z-10">
            <button id="open-panel-btn" class="group w-12 h-12 flex items-center justify-center rounded-full glass-ui interactive-btn" aria-label="Open Stations Panel">
                <i class="fa-solid fa-wave-square text-gray-500 text-xl transition-transform duration-300 ease-in-out icon-rotate"></i>
            </button>
        </header>

        <main class="flex flex-col items-center justify-center flex-grow text-center px-6 sm:px-8 pt-4 pb-20">
            <div class="relative w-72 h-72 sm:w-96 sm:h-96 rounded-2xl overflow-hidden mb-12 shadow-[0_25px_50px_-12px_rgba(0,0,0,0.15)]">
                <div id="album-art-container">
                    <img id="album-art-1" alt="Radio Art" class="album-art-img" src="https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=2070&auto-format&fit=crop">
                    <img id="album-art-2" alt="Radio Art" class="album-art-img">
                </div>
                <div id="image-protection-overlay" class="absolute inset-0 z-10 cursor-default"></div>
            </div>

            <div class="mb-10">
                <h1 id="station-name" class="text-4xl sm:text-5xl font-serif-artistic text-gray-900 leading-tight">Select a Station</h1>
                <p id="playback-status" class="mt-3 text-sm font-semibold tracking-widest text-gray-400 uppercase">Ready</p>
            </div>

            <div class="controls-container glass-ui rounded-full p-3 flex items-center justify-center space-x-4">
                <button id="prev-btn" class="w-16 h-16 flex items-center justify-center text-gray-500 hover:text-gray-800 transition-colors duration-300 interactive-btn" aria-label="Previous Station">
                    <i class="fa-solid fa-backward-step text-2xl"></i>
                </button>
                
                <button id="play-pause-btn" class="relative w-20 h-20 flex items-center justify-center text-slate-700 rounded-full shadow-lg interactive-btn" aria-label="Play or Pause">
                    <!-- Icon injected by JS -->
                </button>

                <button id="next-btn" class="w-16 h-16 flex items-center justify-center text-gray-500 hover:text-gray-800 transition-colors duration-300 interactive-btn" aria-label="Next Station">
                    <i class="fa-solid fa-forward-step text-2xl"></i>
                </button>
            </div>
        </main>

        <div id="stations-panel" class="absolute inset-0 z-20 invisible bg-black/20">
            <div id="panel-content" class="absolute bottom-0 w-full h-[80%] sm:h-[75%] glass-ui rounded-t-[32px] flex flex-col translate-y-full">
                <header class="flex flex-col p-6 border-b border-white/20 flex-shrink-0">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Available Stations</h3>
                        <button id="close-panel-btn" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100/50 transition-all duration-300 ease-in-out hover:bg-gray-200/70 active:scale-90" aria-label="Close Stations Panel">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-600" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
                        </button>
                    </div>
                    <div class="relative">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="search" id="station-search" placeholder="Search for a station..." class="w-full bg-white/40 placeholder-gray-500 text-gray-800 border border-transparent rounded-full pl-11 pr-4 py-3 transition-all duration-300">
                    </div>
                </header>
                <div id="playlist" class="flex-grow overflow-y-auto">
                    <div id="no-results-message" class="hidden text-center p-8 text-gray-500">
                        <p class="font-bold">No stations found</p>
                        <p class="text-sm">Try a different search term.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <audio id="audio-player" preload="none" crossOrigin="anonymous"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            function handleIntro() {
                const splashScreen = document.getElementById('splash-screen');
                const player = document.getElementById('macro-player');
                setTimeout(() => {
                    splashScreen.classList.add('hidden');
                    player.classList.remove('opacity-0');
                }, 3000);
            }

            // --- UPDATED STATION LIST ---
            const stations = [
                // Original Stations
                { name: "KEXP 90.3 FM", sources: ["https://kexp.streamguys1.com/kexp160.aac"] },
                { name: "Radio Paradise", sources: ["https://stream.radioparadise.com/aac-320"] },
                { name: "SomaFM Groove Salad", sources: ["https://ice1.somafm.com/groovesalad-128-mp3"] },
                { name: "KIIS 102.7 FM", sources: ["https://stream.revma.ihrhls.com/zc185"] },
                { name: "Kings Malayalam FM", sources: ["https://stream.zeno.fm/l47xgvrcntyvv"] },
                { name: "Kings Malayalam Rock", sources: ["https://stream.zeno.fm/74atefvsrgsvv"] },
                { name: "Malayalam Devotional", sources: ["https://stream.zeno.fm/1xqc4hfwd48uv"] },
                { name: "Kuzhippalathil Radio", sources: ["https://stream.zeno.fm/qr8ppfs22rhvv"] },
                { name: "KJ Yesudas Malayalam Songs", sources: ["https://stream.zeno.fm/uvdbygm6a48uv"] },
                { name: "Star Radio Malayalam", sources: ["https://stream.zeno.fm/rqrhkw0dvp8uv"] },
                { name: "Malayalam Music Chennai", sources: ["https://stream.zeno.fm/77fs4kfuhnruv"] },
                { name: "YQ Radio (Yours Qatar) â€“ Malayalam", sources: ["https://stream.zeno.fm/1cfdt0n57p8uv"] },
                
                // New Stations Added
                { name: "FM Kottarakkara", sources: ["https://stream.zeno.fm/gqdb1rev5s8uv"] },
                { name: "Kollam 102 FM", sources: ["https://stream.zeno.fm/37fc0c53vv8uv"] },
                { name: "DPB Radio International", sources: ["https://stream.zeno.fm/fm20fub80tzuv"] },
                { name: "Naan FM", sources: ["https://stream.zeno.fm/swgzh04zbg0uv"] },
                { name: "My Radio DJ", sources: ["https://stream.zeno.fm/84h97t3ewg0uv"] },
                { name: "Mohanlal Hits", sources: ["https://stream.zeno.fm/5vva7u4ts0quv"] },
                { name: "Ural Melodics", sources: ["https://stream.zeno.fm/a3250rmrga0uv"] },
                { name: "Goldy Blast", sources: ["https://stream.zeno.fm/d0rwvvwa6p8uv"] },
                { name: "Goldy Sarvaani", sources: ["https://stream.zeno.fm/n2fd0edh9k8uv"] }
            ];

            const iconPlay = `<i class="fa-solid fa-play fa-2x ml-1 text-slate-700"></i>`;
            const iconPause = `<i class="fa-solid fa-pause fa-2x text-slate-700"></i>`;

            const el = {
                audio: document.getElementById('audio-player'),
                playPauseBtn: document.getElementById('play-pause-btn'),
                prevBtn: document.getElementById('prev-btn'),
                nextBtn: document.getElementById('next-btn'),
                playlistContainer: document.getElementById('playlist'),
                stationName: document.getElementById('station-name'),
                playbackStatus: document.getElementById('playback-status'),
                openPanelBtn: document.getElementById('open-panel-btn'),
                closePanelBtn: document.getElementById('close-panel-btn'),
                stationsPanel: document.getElementById('stations-panel'),
                panelContent: document.getElementById('panel-content'),
                albumArt1: document.getElementById('album-art-1'),
                albumArt2: document.getElementById('album-art-2'),
                imageProtectionOverlay: document.getElementById('image-protection-overlay'),
                searchInput: document.getElementById('station-search'),
                noResultsMessage: document.getElementById('no-results-message'),
            };

            let currentIndex = -1;
            let isSwitching = false;

            // --- IMAGE SLIDER LOGIC (UNCHANGED) ---
            const SLIDE_DURATION = 15000;
            const CHUNK_SIZE = 30;
            const FETCH_THRESHOLD = 5;
            let imageList = [], currentImageIndex = 0, picsumPage = 1, isLoadingImages = false, imageInterval;
            let activeImage = el.albumArt1;
            let inactiveImage = el.albumArt2;
            async function fetchImageChunk(page, limit) { try { const response = await fetch(`https://picsum.photos/v2/list?page=${page}&limit=${limit}`); if (!response.ok) throw new Error(`API failed: ${response.status}`); const data = await response.json(); return data.map(p => `https://picsum.photos/id/${p.id}/800/800`); } catch (err) { console.warn("Picsum fetch failed:", err.message); return []; } }
            async function loadMoreImages() { if (isLoadingImages) return; isLoadingImages = true; let newImages = await fetchImageChunk(picsumPage, CHUNK_SIZE); if (picsumPage === 1 && newImages.length > 10) { newImages = newImages.slice(10); } if (newImages.length > 0) { imageList.push(...newImages); picsumPage++; } isLoadingImages = false; }
            function switchImage(newImageUrl) { inactiveImage.src = newImageUrl; inactiveImage.onload = () => { activeImage.classList.remove('visible'); inactiveImage.classList.add('visible'); [activeImage, inactiveImage] = [inactiveImage, activeImage]; }; }
            function cycleAndPreloadNextImage() { if (imageList.length < 2) return; if (imageList.length - currentImageIndex <= FETCH_THRESHOLD) loadMoreImages(); currentImageIndex = (currentImageIndex + 1) % imageList.length; const nextImageUrl = imageList[currentImageIndex]; const preloader = new Image(); preloader.src = nextImageUrl; preloader.onload = () => switchImage(nextImageUrl); preloader.onerror = () => { console.warn(`Skipping broken image: ${nextImageUrl}`); const badIndex = imageList.indexOf(nextImageUrl); if (badIndex > -1) { imageList.splice(badIndex, 1); if (badIndex <= currentImageIndex) currentImageIndex--; } }; }
            function startImageSlider() { if (imageInterval) clearInterval(imageInterval); if (imageList.length > 1) { imageInterval = setInterval(cycleAndPreloadNextImage, SLIDE_DURATION); } }
            
            function generatePlaylist() {
                stations.forEach((station, index) => {
                    const item = document.createElement('div');
                    item.className = 'station-item p-5 text-gray-600 cursor-pointer transition-all duration-300 hover:bg-white/30 border-b border-gray-500/10 border-l-4 border-transparent flex justify-between items-center';
                    item.dataset.index = index;
                    item.innerHTML = `
                        <span class="text-lg font-medium">${station.name}</span>
                        <div class="playing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    `;
                    item.addEventListener('click', () => {
                        selectStation(index);
                        closePanel();
                    });
                    el.playlistContainer.insertBefore(item, el.noResultsMessage);
                });
            }

            function updateActiveStationUI() {
                document.querySelectorAll('.station-item').forEach((item, index) => {
                    const isActive = index === currentIndex;
                    item.classList.toggle('text-gray-900', isActive);
                    item.classList.toggle('font-bold', isActive);
                    item.classList.toggle('bg-white/30', isActive);
                    item.classList.toggle('border-blue-500', isActive);
                });
            }

            function updatePlayingIndicator(isPlaying) {
                document.querySelectorAll('.station-item').forEach((item, index) => {
                    item.classList.toggle('is-playing', index === currentIndex && isPlaying);
                });
            }

            function updateStatus(text) { el.playbackStatus.textContent = text; }

            function trySourceOnce(url, timeoutMs = 15000) {
                return new Promise((resolve, reject) => {
                    el.audio.pause();
                    el.audio.removeAttribute('src');
                    el.audio.load();
                    const finalUrl = url + (url.includes('?') ? '&' : '?') + '_=' + Date.now();
                    let settled = false;
                    const tidy = () => { el.audio.removeEventListener('playing', onPlaying); el.audio.removeEventListener('error', onError); clearTimeout(timer); };
                    const onPlaying = () => { if (!settled) { settled = true; tidy(); resolve(finalUrl); } };
                    const onError = () => { if (!settled) { settled = true; tidy(); reject(new Error('Audio Error')); } };
                    el.audio.addEventListener('playing', onPlaying);
                    el.audio.addEventListener('error', onError);
                    el.audio.src = finalUrl;
                    const playPromise = el.audio.play();
                    if (playPromise !== undefined) { playPromise.catch(err => { if (!settled && err.name === "NotAllowedError") { settled = true; tidy(); reject(new Error('Autoplay Blocked')); } }); }
                    const timer = setTimeout(() => { if (!settled) { settled = true; tidy(); reject(new Error('Timeout')); } }, timeoutMs);
                });
            }

            async function selectStation(index) {
                if (index === currentIndex && !el.audio.paused) return;
                isSwitching = true;
                updatePlayingIndicator(false);
                currentIndex = index;
                const station = stations[index];
                updateActiveStationUI();
                updateStatus('Connecting...');
                el.stationName.textContent = station.name;
                el.playPauseBtn.innerHTML = iconPause;
                let connected = false;
                for (const source of station.sources) {
                    try {
                        await trySourceOnce(source);
                        connected = true;
                        break;
                    } catch (err) { console.error(`Source failed for ${station.name}: ${err.message}`); }
                }
                if (!connected) {
                    updateStatus('Station Unavailable');
                    el.playPauseBtn.innerHTML = iconPlay;
                    el.audio.removeAttribute('src');
                }
                isSwitching = false;
            }

            async function handlePlayPauseClick() { if (currentIndex === -1) { selectStation(0); return; } if (el.audio.paused) { if (el.audio.src) { try { await el.audio.play(); } catch (e) { updateStatus('Play Blocked'); } } else { await selectStation(currentIndex); } } else { el.audio.pause(); } }
            function handleNextClick() { const nextIndex = currentIndex === -1 ? 0 : (currentIndex + 1) % stations.length; selectStation(nextIndex); }
            function handlePrevClick() { const prevIndex = currentIndex <= 0 ? stations.length - 1 : currentIndex - 1; selectStation(prevIndex); }
            function openPanel() { el.stationsPanel.classList.remove('invisible'); requestAnimationFrame(() => { el.panelContent.classList.remove('translate-y-full'); }); }
            function closePanel() { el.panelContent.classList.add('translate-y-full'); setTimeout(() => { el.stationsPanel.classList.add('invisible'); }, 600); }
            function handleSearch() { const query = el.searchInput.value.toLowerCase().trim(); const stationItems = document.querySelectorAll('.station-item'); let visibleCount = 0; stationItems.forEach(item => { const stationName = item.querySelector('span').textContent.toLowerCase(); const isVisible = stationName.includes(query); item.style.display = isVisible ? '' : 'none'; if (isVisible) visibleCount++; }); el.noResultsMessage.style.display = visibleCount === 0 ? 'block' : 'none'; }
            function setupProtection() { el.imageProtectionOverlay.addEventListener('contextmenu', e => e.preventDefault()); el.imageProtectionOverlay.addEventListener('dragstart', e => e.preventDefault()); }

            async function init() {
                handleIntro();
                el.playPauseBtn.innerHTML = iconPlay;
                generatePlaylist();
                
                el.playPauseBtn.addEventListener('click', handlePlayPauseClick);
                el.nextBtn.addEventListener('click', handleNextClick);
                el.prevBtn.addEventListener('click', handlePrevClick);
                el.openPanelBtn.addEventListener('click', openPanel);
                el.closePanelBtn.addEventListener('click', closePanel);
                el.stationsPanel.addEventListener('click', (e) => { if (e.target === el.stationsPanel) closePanel(); });
                el.searchInput.addEventListener('input', handleSearch);
                
                el.audio.addEventListener('playing', () => { el.playPauseBtn.innerHTML = iconPause; updateStatus('Playing'); updatePlayingIndicator(true); });
                el.audio.addEventListener('pause', () => { el.playPauseBtn.innerHTML = iconPlay; if (!isSwitching && currentIndex !== -1) { updateStatus('Paused'); } updatePlayingIndicator(false); });
                el.audio.addEventListener('waiting', () => { if (!isSwitching) updateStatus('Buffering...'); updatePlayingIndicator(false); });
                
                setupProtection();

                await loadMoreImages();
                if (imageList.length > 0) {
                    el.albumArt1.src = imageList[0];
                    el.albumArt1.classList.add('visible');
                    startImageSlider();
                }
            }
            init();
        });
    </script>

</body>
</html>
